# -*- coding: utf-8 -*-

import sys, os, xbmc, xbmcplugin, xbmcvfs
import urllib
from urlparse import urljoin

REPO_PACKAGE_DIR = "special://home/addons/packages/"
REPO_INSTALL_DIR = "special://home/addons/"

class AddonInstaller:
    def __init__(self, data_dir, zip = True):
        self.data_dir = data_dir
        self.zip = zip
        self.handle = int(sys.argv[1])

    def process(self, action, package, version):
        success = False
        if "install" == action:
            success = self._install(package, version)
        elif "uninstall" == action:
            success = self._uninstall(package)

        xbmc.executebuiltin("UpdateLocalAddons")
        xbmcplugin.endOfDirectory(self.handle, success)

    def _install(self, package, version):
        packageFile = self._download(urljoin(self.data_dir, "%s/%s-%s.zip" % (package, package, version)))
        if packageFile:
            from zipfile import is_zipfile

            if not is_zipfile(packageFile): # bad archive
                return False

            self.log("Installing addon: %s, version: %s" % (package, version), level=xbmc.LOGNOTICE)

            newAddonDir = os.path.join(xbmc.translatePath(REPO_INSTALL_DIR), package)
            if xbmcvfs.exists(newAddonDir): # update
                self._rmtree(newAddonDir)

            return self._extract(packageFile)
        return False;    

    def _uninstall(self, package):
        addonDir = os.path.join(xbmc.translatePath(REPO_INSTALL_DIR), package)
        if xbmcvfs.exists(addonDir):
            self._rmtree(addonDir, removeSelf=True)
        return False;    

    def _download(self, url, destination = REPO_PACKAGE_DIR):
        destination = os.path.join(xbmc.translatePath(destination), os.path.basename(url))
        if not xbmcvfs.exists(destination):
            destination, h = urllib.urlretrieve(url, destination)
        return destination

    def _extract(self, filename, destination = REPO_INSTALL_DIR):
        from zipfile import ZipFile
        with ZipFile(filename, "r") as zip:
            zip.extractall(xbmc.translatePath(destination))
        return True

    def _rmtree(self, directory, removeSelf = False):
        self.log("Processing folder %s" % fileName, level=xbmc.LOGDEBUG)

        dirs, files = xbmcvfs.listdir(directory)
        for f in files:
            fileName = os.path.join(directory, f)
            self.log(" -- delete %s" % fileName, level=xbmc.LOGDEBUG)
            xbmcvfs.delete(fileName)
        for d in dirs:
            self._rmtree(os.path.join(directory, d), removeSelf=True)
        if removeSelf:
            self.log(" -- delete %s" % directory, level=xbmc.LOGDEBUG)
            xbmcvfs.rmdir(directory)

    def log(self, message, level=xbmc.LOGNOTICE):
        xbmc.log("[%]: %s" % (self.__class__.__name__, message), level=xbmc.LOGDEBUG)
    